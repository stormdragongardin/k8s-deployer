# ========================================
# Gateway API 测试配置
# 域名: test.example.com
# ========================================
# 
# 测试步骤:
#   1. 部署此配置: kubectl apply -f examples/gateway-test.yaml
#   2. 等待 Gateway 就绪: kubectl get gateway default-gateway
#   3. 查看 Gateway IP: kubectl get gateway default-gateway -o jsonpath='{.status.addresses[0].value}'
#   4. 测试访问: curl -H "Host: test.example.com" http://10.0.6.1
#   5. 或者配置 DNS 解析后直接访问: curl http://test.example.com
#
# 清理:
#   kubectl delete -f examples/gateway-test.yaml
#

---
# ========================================
# Gateway 资源
# ========================================
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: default-gateway
  namespace: default
  annotations:
    # 指定固定的 LoadBalancer IP (10.0.6.1 预留给 Gateway)
    io.cilium/lb-ipam-ips: "10.0.6.1"
spec:
  gatewayClassName: cilium
  listeners:
  # HTTP 监听器
  - name: http
    protocol: HTTP
    port: 80
    allowedRoutes:
      namespaces:
        from: All  # 允许所有 namespace 的路由

---
# ========================================
# 测试应用: Echo Server
# ========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server
  namespace: default
  labels:
    app: echo-server
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo-server
  template:
    metadata:
      labels:
        app: echo-server
    spec:
      containers:
      - name: echo
        image: ealen/echo-server:latest
        ports:
        - containerPort: 80
        env:
        - name: PORT
          value: "80"
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi

---
# ========================================
# 测试应用: Service
# ========================================
apiVersion: v1
kind: Service
metadata:
  name: echo-server
  namespace: default
spec:
  selector:
    app: echo-server
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP

---
# ========================================
# HTTPRoute: test.example.com
# ========================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: test-route
  namespace: default
spec:
  # 关联到 Gateway
  parentRefs:
  - name: default-gateway
    namespace: default
  
  # 主机名匹配
  hostnames:
  - "test.example.com"
  
  # 路由规则
  rules:
  # 匹配所有路径
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: echo-server
      port: 80

